
 ## Comandos usados en OpenSSL
 ```
### Ver version de openssl y las rutas kpi 
openssl version -a 

### Ver todos los algoritmos que se pueden usar 
openssl  ciphers  -v  'ALL:eNULL'  | awk '{print $2 " " $1}' | sort | column -t |  grep "1.3"

# Validar si S.O aplica algunas restrincciones 
 openssl list -cipher-algorithms

### Excluyes algoritmos 
openssl ciphers -v 'ALL:!MD5:!3DES:!RC4:!DES:!IDEA:!RC2' | column -t
openssl ciphers -v 'MD5:RC4:3DES:DES:IDEA:RC2:SHA1:NULL:aNULL:EXP'
openssl ciphers -v 'RC4-MD5:RC4-SHA:DES-CBC3-SHA:IDEA-CBC-SHA:RC2-CBC-MD5:EXP-RC4-MD5:EXP-DES-CBC-SHA:NULL-MD5:NULL-SHA:MD5'
 ```



## Validar las conexiones
 ```
openssl s_client -connect 172.10.10.100:5416 -starttls postgres -tls1_3 -ciphersuites TLS_AES_256_GCM_SHA384  -CAfile  combined.crt -verify_return_error -tlsextdebug -status  -showcerts
openssl s_client -connect 127.0.0.1:5416 -starttls postgres -tls1_2 -cert /tmp/pki/certs/client_new.crt -key /tmp/pki/private/client_new.key -CAfile /tmp/pki/CA/ca-chain.crt


 ParÃ¡metro                     Â¿QuÃ© hace?                                                                 
----------------------------------------------------------------------------------------------------------
 `-connect host:port`         Especifica la direcciÃ³n y puerto del servidor al que deseas conectarte     
 `-starttls protocolo`        Inicia un *handshake* TLS para protocolos como `postgres`, `smtp`, `ftp`   
 `-tls1_2`, `-tls1_3`         Fuerza la versiÃ³n de TLS que deseas usar en la conexiÃ³n                    
 `-ciphersuites`              >= tls1.3 Seleccionas  explÃ­citamente cual cipher suites usar , Ejemplo ->   TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256             
 `-cipher`                    <= 1.2 aqui filtras los cipher suites. Ejemplo -> 'HIGH:!aNULL:!MD5:!3DES:!RC4:!DES:!IDEA:!RC2'                
 `-CAfile archivo.crt`        Usa certificados raÃ­z/intermedios para validar el certificado del servidor 
 `-verify_return_error`       Falla la conexiÃ³n si no se puede verificar el certificado                   
 `-showcerts`                 Muestra todos los certificados entregados por el servidor                  
 `-servername nombre`         Establece el SNI (Server Name Indication), Ãºtil si el servidor tiene mÃºltiples dominios 
 `-quiet`                     Silencia detalles del protocolo para una salida mÃ¡s limpia
 `-brief`                      mostrar una salida mÃ¡s concisa y enfocada durante la simulaciÃ³n de una conexiÃ³n TLS/SSL. En lugar de imprimir todo el certificado, la cadena completa

 ```


 

## ğŸš« Algoritmos inseguros en TLS 1.2 que debes excluir

| ğŸ”‘ Algoritmo / Cipher Suite             | âŒ Â¿Por quÃ© evitarlo?                          |
|----------------------------------------|-----------------------------------------------|
| `RC4`                                  | Vulnerable a ataques de sesgo en el cifrado   |
| `3DES` (`Triple DES`)                  | Tiene solo 112 bits efectivos â€” dÃ©bil         |
| `MD5`                                  | Algoritmo hash roto â€” susceptible a colisiones|
| `SHA1`                                 | DÃ©bil frente a ataques de colisiÃ³n            |
| `DES`, `IDEA`, `RC2`                   | Cifrados antiguos y fÃ¡cilmente rompibles      |
| `NULL`, `aNULL`, `EXP`                 | No cifran o permiten autenticaciÃ³n nula       |
| `CBC` sin AEAD (como `AES_128_CBC`)    | Vulnerable a ataques como BEAST y Lucky13     |

---

## ğŸ›¡ï¸ Â¿CÃ³mo excluirlos en en PostgreSQL?

Puedes usar el parÃ¡metro 
 ```
ssl_prefer_server_ciphers = on
ssl_ciphers =  'HIGH:!MD5:!RC4:!3DES:!DES:!IDEA:!RC2:!SHA1:!NULL:!aNULL:!EXP'
 ```


### Validar  todos los algorimos debiles manualmente 
```
openssl s_client -connect 127.0.0.1:5416 -starttls postgres -cipher 'RC4-MD5:RC4-SHA:DES-CBC3-SHA:IDEA-CBC-SHA:RC2-CBC-MD5:EXP-RC4-MD5:EXP-DES-CBC-SHA:NULL-MD5:NULL-SHA:MD5'
openssl s_client -connect 127.0.0.1:5416 -starttls postgres -cipher 'RC4-MD5:RC4-SHA:DES-CBC3-SHA:IDEA-CBC-SHA:RC2-CBC-MD5:EXP-RC4-MD5:EXP-DES-CBC-SHA:NULL-MD5:NULL-SHA:MD5'
```


## Herramienta para testear TLS 
```
postgres@pruebas-dba /sysx/data16/$ ./pgTLSCheck.sh -h 127.0.0.1 -p 5416 -U postgres -v 0 --tls-connect-check --tls-scan --date-check --tls-supported-ciphers

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ ParÃ¡metros recibidos:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â€¢ Nivel de verbose:       0
â€¢ HOST objetivo:          127.0.0.1
â€¢ Puerto:                 5416
â€¢ Usuario (DB):           postgres
â€¢ Base de datos:          postgres
â€¢ ContraseÃ±a requerida:   false
â€¢ Alcance al servidor:    EXITOSO
â€¢ Verificando conexiÃ³n a PostgreSQL...
   ğŸ” ConexiÃ³n SSL exitosa.
    â€¢ Detalles SSL:
+-----+---------+------------------------+
| ssl | version |         cipher         |
+-----+---------+------------------------+
| t   | TLSv1.3 | TLS_AES_256_GCM_SHA384 |
+-----+---------+------------------------+
(1 row)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” Escaneando TLS TLS1 en 127.0.0.1:5416
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âŒ Resultado:
   â€¢ No se pudo establecer conexiÃ³n TLS (tls1)

ğŸ” CIPHERS SOPORTADOS: tls1
Cipher                                     | Resultado
-------------------------------------------+-------------

ğŸ“Š Resumen de Ciphers tls1:
âœ” Ciphers aceptados: 0
âœ˜ Ciphers rechazados: 186

âš  No se logrÃ³ negociar ningÃºn cipher con TLS tls1.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” Escaneando TLS TLS1_1 en 127.0.0.1:5416
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âŒ Resultado:
   â€¢ No se pudo establecer conexiÃ³n TLS (tls1_1)

ğŸ” CIPHERS SOPORTADOS: tls1.1
Cipher                                     | Resultado
-------------------------------------------+-------------

ğŸ“Š Resumen de Ciphers tls1.1:
âœ” Ciphers aceptados: 0
âœ˜ Ciphers rechazados: 186

âš  No se logrÃ³ negociar ningÃºn cipher con TLS tls1.1.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” Escaneando TLS TLS1_2 en 127.0.0.1:5416
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Resultado (moderno):
   âœ” ConexiÃ³n exitosa
   â€¢ Cipher negociado: ECDHE-RSA-AES256-GCM-SHA384
   â€¢ Seguridad avanzada: TLS TLS1_2
   â€¢ Subject: C = MX, ST = SINALOA, L = Culiac\C3\A1n, O = dominio_test S.A. de C.V., CN = *.dominio_test.io
   â€¢ Issuer: C = US, O = DigiCert Inc, CN = DigiCert Global G2 TLS RSA SHA256 2020 CA1
   â€¢ DNS:*.dominio_test.io, DNS:dominio_test.io
ğŸ“„ Estado del Certificado:
   â€¢ Status:         âš ï¸ Por expirar
   â€¢ Vigencia desde: 11/07/2024 17:00:00
   â€¢ Vigencia hasta: 11/07/2025 16:59:59


ğŸ” CIPHERS SOPORTADOS: tls1.2
Cipher                                     | Resultado
-------------------------------------------+-------------
AES128-CCM                                 | âœ” Conectado
AES128-CCM8                                | âœ” Conectado
AES128-GCM-SHA256                          | âœ” Conectado
AES128-SHA256                              | âœ” Conectado
AES256-CCM                                 | âœ” Conectado
AES256-CCM8                                | âœ” Conectado
AES256-GCM-SHA384                          | âœ” Conectado
AES256-SHA256                              | âœ” Conectado
ARIA128-GCM-SHA256                         | âœ” Conectado
ARIA256-GCM-SHA384                         | âœ” Conectado
CAMELLIA128-SHA256                         | âœ” Conectado
CAMELLIA256-SHA256                         | âœ” Conectado
DHE-RSA-AES128-CCM                         | âœ” Conectado
DHE-RSA-AES128-CCM8                        | âœ” Conectado
DHE-RSA-AES128-GCM-SHA256                  | âœ” Conectado
DHE-RSA-AES128-SHA256                      | âœ” Conectado
DHE-RSA-AES256-CCM                         | âœ” Conectado
DHE-RSA-AES256-CCM8                        | âœ” Conectado
DHE-RSA-AES256-GCM-SHA384                  | âœ” Conectado
DHE-RSA-AES256-SHA256                      | âœ” Conectado
DHE-RSA-ARIA128-GCM-SHA256                 | âœ” Conectado
DHE-RSA-ARIA256-GCM-SHA384                 | âœ” Conectado
DHE-RSA-CAMELLIA128-SHA256                 | âœ” Conectado
DHE-RSA-CAMELLIA256-SHA256                 | âœ” Conectado
DHE-RSA-CHACHA20-POLY1305                  | âœ” Conectado
ECDHE-ARIA128-GCM-SHA256                   | âœ” Conectado
ECDHE-ARIA256-GCM-SHA384                   | âœ” Conectado
ECDHE-RSA-AES128-GCM-SHA256                | âœ” Conectado
ECDHE-RSA-AES128-SHA256                    | âœ” Conectado
ECDHE-RSA-AES256-GCM-SHA384                | âœ” Conectado
ECDHE-RSA-AES256-SHA384                    | âœ” Conectado
ECDHE-RSA-CAMELLIA128-SHA256               | âœ” Conectado
ECDHE-RSA-CAMELLIA256-SHA384               | âœ” Conectado
ECDHE-RSA-CHACHA20-POLY1305                | âœ” Conectado

ğŸ“Š Resumen de Ciphers tls1.2:
âœ” Ciphers aceptados: 34
âœ˜ Ciphers rechazados: 152

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” Escaneando TLS TLS1_3 en 127.0.0.1:5416
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Resultado (moderno):
   âœ” ConexiÃ³n exitosa
   â€¢ Cipher negociado: TLS_AES_256_GCM_SHA384
   â€¢ Seguridad avanzada: TLS TLS1_3
   â€¢ Subject: C = MX, ST = SINALOA, L = Culiac\C3\A1n, O = dominio_test S.A. de C.V., CN = *.dominio_test.io
   â€¢ Issuer: C = US, O = DigiCert Inc, CN = DigiCert Global G2 TLS RSA SHA256 2020 CA1
   â€¢ DNS:*.dominio_test.io, DNS:dominio_test.io
ğŸ“„ Estado del Certificado:
   â€¢ Status:         âš ï¸ Por expirar
   â€¢ Vigencia desde: 11/07/2024 17:00:00
   â€¢ Vigencia hasta: 11/07/2025 16:59:59


ğŸ” CIPHERS SOPORTADOS: tls1.3
Cipher                                     | Resultado
-------------------------------------------+-------------
TLS_AES_128_CCM_SHA256                     | âœ” Conectado
TLS_AES_128_GCM_SHA256                     | âœ” Conectado
TLS_AES_256_GCM_SHA384                     | âœ” Conectado
TLS_CHACHA20_POLY1305_SHA256               | âœ” Conectado

ğŸ“Š Resumen de Ciphers tls1.3:
âœ” Ciphers aceptados: 4
âœ˜ Ciphers rechazados: 182

```
