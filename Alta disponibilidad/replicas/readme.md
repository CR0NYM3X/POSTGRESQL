 

## üéØ ¬øPara qu√© sirve hacer r√©plicas en PostgreSQL?

### ‚úÖ 1. **Alta disponibilidad (High Availability)**
- La replicaci√≥n permite que una base de datos est√© disponible incluso si el servidor principal falla. Los datos se copian a uno o m√°s servidores de r√©plica, que pueden asumir el rol del servidor principal en caso de fallo.


### ‚úÖ 2. **Balanceo de carga (Load Balancing)**
- Las r√©plicas pueden ser utilizadas para distribuir la carga de trabajo, permitiendo que las consultas de solo lectura se ejecuten en los servidores de r√©plica, aliviando la carga del servidor principal.

### ‚úÖ 3. **Recuperaci√≥n ante desastres (Disaster Recovery)**
- En caso de un desastre, las r√©plicas pueden ser utilizadas para restaurar r√°pidamente los datos y minimizar el tiempo de inactividad.

### ‚úÖ 4. **An√°lisis sin afectar producci√≥n**
- Puedes hacer an√°lisis pesados o pruebas en una r√©plica sin afectar el rendimiento del servidor principal.

### ‚úÖ 5. **Migraciones o actualizaciones**
- Puedes usar una r√©plica l√≥gica para migrar datos entre versiones diferentes de PostgreSQL o hacia otro sistema.

### ‚úÖ 6. **Integraci√≥n con otros sistemas**
- La replicaci√≥n l√≥gica permite enviar cambios en tiempo real a sistemas como Kafka, Elasticsearch, BigQuery, etc.

---

## üîÑ ¬øCu√°ndo usar cada tipo?

| Objetivo | Tipo de r√©plica recomendada | ¬øPor qu√©? |
|---------|------------------------------|-----------|
| Alta disponibilidad | **Streaming (f√≠sica)** | R√©plica exacta del servidor, lista para tomar el control. |
| Balanceo de carga | **Streaming (f√≠sica)** | Ideal para consultas de solo lectura. |
| An√°lisis o BI | **L√≥gica** | Puedes replicar solo ciertas tablas. |
| Integraci√≥n con otros sistemas | **L√≥gica** | Permite enviar cambios en formato JSON o eventos. |
| Migraci√≥n entre versiones | **L√≥gica** | Compatible entre versiones distintas. |


 
### üîπ **Failover**
El **failover** ocurre cuando el **nodo primario** falla inesperadamente y un nodo **standby** se convierte autom√°ticamente en el nuevo **nodo primario**.  
‚úÖ Se activa de manera autom√°tica en sistemas configurados con monitoreo y failover.  
‚úÖ Evita la ca√≠da total del servicio.  
‚úÖ Se usa en escenarios de emergencia cuando el servidor principal deja de funcionar.  
Ejemplo de comando manual:
 
### üîπ **Switchover**
El **switchover** es un proceso planificado en el que el nodo **primario** y uno **standby** intercambian roles de forma controlada.  
‚úÖ Se realiza sin que haya fallos en el sistema.  
‚úÖ Se usa para mantenimiento o actualizaciones del nodo primario.  
‚úÖ Permite cambiar de l√≠der sin interrupciones.  
 

üí° **Diferencia clave:**  
- **Failover** = Evento inesperado, ocurre por una falla.  
- **Switchover** = Cambio intencional y programado.


---

## ‚ö†Ô∏è Consideraciones

- La **replicaci√≥n f√≠sica** es m√°s simple y r√°pida, pero menos flexible.
- La **replicaci√≥n l√≥gica** es m√°s flexible (puedes elegir tablas), pero requiere m√°s configuraci√≥n.
- Ambas pueden coexistir si configuras `wal_level = logical`.

 

## üîç Niveles de `wal_level` en PostgreSQL

### 1. `minimal`
- **¬øQu√© hace?**  
  Registra solo lo estrictamente necesario para la recuperaci√≥n ante fallos.
- **Uso t√≠pico:**  
  Operaciones de carga masiva (`COPY`, `INSERT`) cuando no se necesita replicaci√≥n ni puntos de recuperaci√≥n avanzados.
- **Ventajas:**  
  - Menor volumen de WAL.
  - Mejor rendimiento en operaciones masivas.
- **Desventajas:**  
  - No permite replicaci√≥n.
  - No se puede usar para backups PITR (Point-In-Time Recovery).

---

### 2. `replica` (antes llamado `archive`)
- **¬øQu√© hace?**  
  Registra suficiente informaci√≥n para replicaci√≥n f√≠sica y recuperaci√≥n PITR.
- **Uso t√≠pico:**  
  Replicaci√≥n f√≠sica entre servidores PostgreSQL (standby).
- **Ventajas:**  
  - Permite replicaci√≥n f√≠sica.
  - Compatible con herramientas de backup como `pg_basebackup`.
- **Desventajas:**  
  - No permite replicaci√≥n l√≥gica.
  - M√°s volumen de WAL que `minimal`.

---

### 3. `logical`
- **¬øQu√© hace?**  
  Registra todos los cambios necesarios para replicaci√≥n l√≥gica (como `wal2json`, `pgoutput`, etc.).
- **Uso t√≠pico:**  
  - Replicaci√≥n l√≥gica.
  - Integraci√≥n con sistemas externos (Kafka, Debezium, etc.).
  - Captura de datos en cambio (CDC).
- **Ventajas:**  
  - Permite replicaci√≥n l√≥gica y f√≠sica.
  - Ideal para arquitecturas orientadas a eventos.
- **Desventajas:**  
  - Mayor volumen de WAL.
  - Puede impactar el rendimiento si no se gestiona bien.

 

# Conceptos que se usan en las replicas 
```sql

Maestro/Primario
Esclavo/secundario/standby

- **Activo-Activo**:  En PostgreSQL 16, se ha mejorado la replicaci√≥n l√≥gica para permitir una configuraci√≥n Activo-Activo, donde dos instancias de PostgreSQL pueden recibir escrituras simult√°neamente y sincronizar los cambios entre ellas.
En este modelo, todos los nodos est√°n operativos y procesan solicitudes y cambios simult√°neamente. Esto permite distribuir la carga de trabajo entre m√∫ltiples servidores, mejorando el rendimiento y la disponibilidad. Si un nodo falla, los dem√°s contin√∫an funcionando sin interrupciones.

- **Activo-Pasivo**: Aqu√≠, solo un nodo est√° activo y maneja las solicitudes, mientras que otro nodo permanece en espera (pasivo). Si el nodo activo falla, el pasivo puede toma el control mediante failover. Este enfoque es m√°s simple y garantiza estabilidad, pero no aprovecha los recursos del nodo pasivo hasta que sea necesario.

El **split-brain** es un problema que ocurre en sistemas de alta disponibilidad y replicaci√≥n, cuando dos nodos **pierden comunicaci√≥n entre s√≠**, pero **ambos creen que son el primario** al mismo tiempo.
----------------------------------------------------------------------------------------------------------------------------------------------------------------
El **qu√≥rum** es el n√∫mero m√≠nimo de nodos que deben estar **de acuerdo** para tomar decisiones dentro de un cl√∫ster distribuido, como el failover en PostgreSQL con **Repmgr**, **Patroni**, o sistemas como **etcd/Consul**.  

  **¬øC√≥mo funciona el qu√≥rum en alta disponibilidad?**  
  **1. Se requiere mayor√≠a (m√°s del 50%)**  
- Si tienes 5 nodos en total, **al menos 3 deben estar activos y en consenso** para tomar decisiones.  
- Evita que un solo nodo pueda decidir unilateralmente.  

  **2. Impide problemas de split-brain**  
- Si un primario falla y no hay qu√≥rum, **no se elige un nuevo primario** hasta que haya consenso.  
- Protege contra la promoci√≥n accidental de m√∫ltiples primarios.  


  **Ejemplo real de qu√≥rum en PostgreSQL con 3 nodos**  
  *Si tienes 3 nodos (`pgmaster`, `pgslave1`, `pgslave2`) y `pgmaster` falla:*  
-  Si **solo `pgslave1` sigue activo**, no hay qu√≥rum y no ocurre failover.  
-  Si **`pgslave1` y `pgslave2` siguen activos**, hay qu√≥rum y uno de ellos se promueve a primario.  
----------------------------------------------------------------------------------------------------------------------------------------------------------------

¬øQu√© significa el consenso en t√©rminos generales?  Es un acuerdo entre m√∫ltiples participantes ‚Üí Un grupo debe tomar una decisi√≥n colectiva basada en reglas claras.  Evita que haya decisiones individuales incorrectas ‚Üí Por ejemplo, en replicaci√≥n de bases de datos, un nodo no puede decidir solo convertirse en primario sin confirmaci√≥n de los dem√°s.  Se usa en algoritmos de failover y gesti√≥n de sistemas distribuidos ‚Üí Como Raft, Paxos y Etcd, que permiten que los servidores acuerden qui√©n es el l√≠der.
----------------------------------------------------------------------------------------------------------------------------------------------------------------

CAP Theorem ‚Üí En bases de datos distribuidas, puedes tener Consistencia (C), Disponibilidad (A) o Tolerancia a Particiones (P), pero nunca las tres simult√°neamente.
----------------------------------------------------------------------------------------------------------------------------------------------------------------


## Bibliograf√≠a 
```
https://www.youtube.com/watch?v=kW8xT_cgEMM
```
