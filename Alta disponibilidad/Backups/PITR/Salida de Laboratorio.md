
# Salida de laboratorio 
```
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $ /usr/pgsql-16/bin/initdb -E UTF-8 -D /sysx/data16/DATANEW/PITR --data-checksums

The files belonging to this database system will be owned by user "postgres".
This user must also own the server process.

The database cluster will be initialized with locale "en_US.UTF-8".
The default text search configuration will be set to "english".

Data page checksums are enabled.

fixing permissions on existing directory /sysx/data16/DATANEW/PITR ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... posix
selecting default max_connections ... 
100
selecting default shared_buffers ... 
128MB
selecting default time zone ... America/Mazatlan
creating configuration files ... ok
running bootstrap script ... 
ok
performing post-bootstrap initialization ... 
ok
syncing data to disk ... ok

initdb: warning: enabling "trust" authentication for local connections
initdb: hint: You can change this by editing pg_hba.conf or using the option -A, or --auth-local and --auth-host, the next time you run initdb.

Success. You can CLOCK_TIMESTAMP start the database server using:

    /usr/pgsql-16/bin/pg_ctl -D /sysx/data16/DATANEW/PITR -l logfile start

postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $ echo "
> wal_level = replica
> archive_mode = on
> archive_command = 'cp %p /sysx/data16/DATANEW/backup_wal/%f'
> max_wal_senders = 5
> wal_keep_size = 512MB
> port=5599" >>  /sysx/data16/DATANEW/PITR/postgresql.auto.conf
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $ cat /sysx/data16/DATANEW/PITR/postgresql.auto.conf
# Do not edit this file manually!
# It will be overwritten by the ALTER SYSTEM command.

wal_level = replica
archive_mode = on
archive_command = 'cp %p /sysx/data16/DATANEW/backup_wal/%f'
max_wal_senders = 5
wal_keep_size = 512MB
port=5599
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $ /usr/pgsql-16/bin/pg_ctl start -D /sysx/data16/DATANEW/PITR

waiting for server to start....
2025-07-10 12:35:28.129 MST [464606] LOG:  redirecting log output to logging collector process
2025-07-10 12:35:28.129 MST [464606] HINT:  Future log output will appear in directory "log".
 done
server started
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $ psql -p 5519
psql: error: connection to server on socket "/run/postgresql/.s.PGSQL.5519" failed: No such file or directory
        Is the server running locally and accepting connections on that socket?
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $ psql -p 5599


 üêò Current Host Server Date Time : Thu Jul 10 12:35:40 MST 2025

psql (17.5, server 16.9)
Type "help" for help.

postgres@postgres#
postgres@postgres#
postgres@postgres# SELECT CLOCK_TIMESTAMP(),pg_walfile_name(pg_current_wal_lsn()),pg_current_wal_lsn(),pg_current_wal_insert_lsn();
SELECT pg_switch_wal();
SELECT CLOCK_TIMESTAMP(),pg_walfile_name(pg_current_wal_lsn()),pg_current_wal_lsn(),pg_current_wal_insert_lsn();
+------------------------------+--------------------------+--------------------+---------------------------+
|             CLOCK_TIMESTAMP              |     pg_walfile_name      | pg_current_wal_lsn | pg_current_wal_insert_lsn |
+------------------------------+--------------------------+--------------------+---------------------------+
| 2025-07-10 12:35:43.07584-07 | 000000010000000000000001 | 0/17273B8          | 0/17273B8                 |
+------------------------------+--------------------------+--------------------+---------------------------+
(1 row)

Time: 0.963 ms
postgres@postgres# -- Asegurar que el archivo WAL que marca el inicio del respaldo sea archivado inmediatamente y se cree el .backup
postgres@postgres# SELECT pg_switch_wal();

+---------------+
| pg_switch_wal |
+---------------+
| 0/17273D0     |
+---------------+
(1 row)

Time: 15.850 ms
postgres@postgres# SELECT CLOCK_TIMESTAMP(),pg_walfile_name(pg_current_wal_lsn()),pg_current_wal_lsn(),pg_current_wal_insert_lsn();

+-------------------------------+--------------------------+--------------------+---------------------------+
|              CLOCK_TIMESTAMP              |     pg_walfile_name      | pg_current_wal_lsn | pg_current_wal_insert_lsn |
+-------------------------------+--------------------------+--------------------+---------------------------+
| 2025-07-10 12:35:43.928874-07 | 000000010000000000000002 | 0/2000060          | 0/2000060                 |
+-------------------------------+--------------------------+--------------------+---------------------------+
(1 row)

Time: 0.291 ms
postgres@postgres# \q
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $  /usr/pgsql-16/bin/pg_basebackup -D /sysx/data16/DATANEW/backup_base -F p -U postgres -Xs -P -v -h 127.0.0.1 -p 5599
pg_basebackup: initiating base backup, waiting for checkpoint to complete
pg_basebackup: checkpoint completed
pg_basebackup: write-ahead log start point: 0/3000028 on timeline 1
pg_basebackup: starting background WAL receiver
pg_basebackup: created temporary replication slot "pg_basebackup_464769"
23089/23089 kB (100%), 1/1 tablespace
pg_basebackup: write-ahead log end point: 0/3000138
pg_basebackup: waiting for background process to finish streaming ...
pg_basebackup: syncing data to disk ...
pg_basebackup: renaming backup_manifest.tmp to backup_manifest
pg_basebackup: base backup completed
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $ psql -p 5599


 üêò Current Host Server Date Time : Thu Jul 10 12:36:38 MST 2025

psql (17.5, server 16.9)
Type "help" for help.

postgres@postgres# CREATE TABLE laboratorio_pitr (
postgres(#     id SERIAL PRIMARY KEY,
postgres(#     nombre TEXT NOT NULL,
postgres(#     creado_en TIMESTAMP DEFAULT CLOCK_TIMESTAMP()
postgres(# );
CREATE TABLE
Time: 8.312 ms
postgres@postgres#
postgres@postgres#
postgres@postgres# -- Insertar a la 1pm
postgres@postgres# INSERT INTO laboratorio_pitr (nombre, creado_en) VALUES
postgres-# ('registro_1', '2025-07-08 07:45:00'),
postgres-# ('registro_2', '2025-07-08 07:50:00');
INSERT 0 2
Time: 1.342 ms
postgres@postgres# SELECT CLOCK_TIMESTAMP(),pg_walfile_name(pg_current_wal_lsn()),pg_current_wal_lsn(),pg_current_wal_insert_lsn();

+-------------------------------+--------------------------+--------------------+---------------------------+
|              CLOCK_TIMESTAMP              |     pg_walfile_name      | pg_current_wal_lsn | pg_current_wal_insert_lsn |
+-------------------------------+--------------------------+--------------------+---------------------------+
| 2025-07-10 12:36:52.242927-07 | 000000010000000000000004 | 0/4031EA8          | 0/4031EA8                 |
+-------------------------------+--------------------------+--------------------+---------------------------+
(1 row)

Time: 0.327 ms
postgres@postgres# SELECT pg_create_restore_point('punto_laboratorio');

+-------------------------+
| pg_create_restore_point |
+-------------------------+
| 0/4031F10               |
+-------------------------+
(1 row)

Time: 0.369 ms
postgres@postgres#  SELECT pg_switch_wal();

+---------------+
| pg_switch_wal |
+---------------+
| 0/407A620     |
+---------------+
(1 row)

Time: 28.146 ms
postgres@postgres#  SELECT CLOCK_TIMESTAMP(),pg_walfile_name(pg_current_wal_lsn()),pg_current_wal_lsn(),pg_current_wal_insert_lsn();

+-------------------------------+--------------------------+--------------------+---------------------------+
|              CLOCK_TIMESTAMP              |     pg_walfile_name      | pg_current_wal_lsn | pg_current_wal_insert_lsn |
+-------------------------------+--------------------------+--------------------+---------------------------+
| 2025-07-10 12:37:04.101391-07 | 000000010000000000000004 | 0/5000000          | 0/5000028                 |
+-------------------------------+--------------------------+--------------------+---------------------------+
(1 row)

Time: 0.248 ms
postgres@postgres# SELECT * FROM laboratorio_pitr ORDER BY id;

+----+------------+---------------------+
| id |   nombre   |      creado_en      |
+----+------------+---------------------+
|  1 | registro_1 | 2025-07-08 07:45:00 |
|  2 | registro_2 | 2025-07-08 07:50:00 |
+----+------------+---------------------+
(2 rows)

Time: 0.780 ms
postgres@postgres# \q
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $ # Deneter el servicio
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $ /usr/pgsql-16/bin/pg_ctl stop -D /sysx/data16/DATANEW/PITR
waiting for server to shut down.... done
server stopped
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $ # Borrar los directorios del DATA de postgresql
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $ rm -r /sysx/data16/DATANEW/PITR/*
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $ cp -r /sysx/data16/DATANEW/backup_base/* /sysx/data16/DATANEW/PITR/
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $ touch /sysx/data16/DATANEW/PITR/recovery.signal
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $ echo "
> restore_command = 'cp /sysx/data16/DATANEW/backup_wal/%f %p'
> recovery_target_time = '2025-07-08 08:00:00'  # ‚è∞ Ajusta seg√∫n tu objetivo
> # recovery_target_lsn = 'BBE/697CACC0' # Esto si quiere restaurar un lsn en especifico
> # recovery_target_name = 'punto_laboratorio' # Se puede usar si quieres restaurar con algun nombre y usaste la fun pg_create_restore_point
> recovery_target_action = 'promote'
> recovery_target_timeline = '1'
> " >>  /sysx/data16/DATANEW/PITR/postgresql.auto.conf
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $ cat /sysx/data16/DATANEW/PITR/postgresql.auto.conf
# Do not edit this file manually!
# It will be overwritten by the ALTER SYSTEM command.

wal_level = replica
archive_mode = on
archive_command = 'cp %p /sysx/data16/DATANEW/backup_wal/%f'
max_wal_senders = 5
wal_keep_size = 512MB
port=5599

restore_command = 'cp /sysx/data16/DATANEW/backup_wal/%f %p'
recovery_target_time = '2025-07-08 08:00:00'  # ‚è∞ Ajusta seg√∫n tu objetivo
# recovery_target_lsn = 'BBE/697CACC0' # Esto si quiere restaurar un lsn en especifico
# recovery_target_name = 'punto_laboratorio' # Se puede usar si quieres restaurar con algun nombre y usaste la fun pg_create_restore_point
recovery_target_action = 'promote'
recovery_target_timeline = '1'

postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $ vim /sysx/data16/DATANEW/PITR/postgresql.auto.conf
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $ cat /sysx/data16/DATANEW/PITR/postgresql.auto.conf
# Do not edit this file manually!
# It will be overwritten by the ALTER SYSTEM command.

wal_level = replica
archive_mode = on
archive_command = 'cp %p /sysx/data16/DATANEW/backup_wal/%f'
max_wal_senders = 5
wal_keep_size = 512MB
port=5599

restore_command = 'cp /sysx/data16/DATANEW/backup_wal/%f %p'
recovery_target_time = '2025-07-10 12:36:52.242927-07'  # ‚è∞ Ajusta seg√∫n tu objetivo
# recovery_target_lsn = 'BBE/697CACC0' # Esto si quiere restaurar un lsn en especifico
# recovery_target_name = 'punto_laboratorio' # Se puede usar si quieres restaurar con algun nombre y usaste la fun pg_create_restore_point
recovery_target_action = 'promote'
recovery_target_timeline = '1'

postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $ chown -R postgres:postgres /sysx/data16/DATANEW/PITR
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $ /usr/pgsql-16/bin/pg_ctl start -D /sysx/data16/DATANEW/PITR

waiting for server to start....
2025-07-10 12:40:57.309 MST [466529] LOG:  redirecting log output to logging collector process
2025-07-10 12:40:57.309 MST [466529] HINT:  Future log output will appear in directory "log".
 done
server started
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $ psql -p 5599


 üêò Current Host Server Date Time : Thu Jul 10 12:41:15 MST 2025

psql (17.5, server 16.9)
Type "help" for help.

postgres@postgres#
postgres@postgres#
postgres@postgres# \dt

               List of relations
+--------+------------------+-------+----------+
| Schema |       Name       | Type  |  Owner   |
+--------+------------------+-------+----------+
| public | laboratorio_pitr | table | postgres |
+--------+------------------+-------+----------+
(1 row)

postgres@postgres# SELECT pg_is_in_recovery();

+-------------------+
| pg_is_in_recovery |
+-------------------+
| f                 |
+-------------------+
(1 row)

Time: 0.483 ms
postgres@postgres# select * from laboratorio_pitr;

+----+------------+---------------------+
| id |   nombre   |      creado_en      |
+----+------------+---------------------+
|  1 | registro_1 | 2025-07-08 07:45:00 |
|  2 | registro_2 | 2025-07-08 07:50:00 |
+----+------------+---------------------+
(2 rows)

Time: 0.810 ms
postgres@postgres# \q
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $ grep -A 100 "2025-07-10 12:40:57.309" /sysx/data16/DATANEW/PITR/log/postgresql-Thu.log
2025-07-10 12:40:57.309 MST [466529] LOG:  starting PostgreSQL 16.9 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 8.5.0 20210514 (Red Hat 8.5.0-26), 64-bit
2025-07-10 12:40:57.312 MST [466529] LOG:  listening on IPv6 address "::1", port 5599
2025-07-10 12:40:57.312 MST [466529] LOG:  listening on IPv4 address "127.0.0.1", port 5599
2025-07-10 12:40:57.314 MST [466529] LOG:  listening on Unix socket "/run/postgresql/.s.PGSQL.5599"
2025-07-10 12:40:57.316 MST [466529] LOG:  listening on Unix socket "/tmp/.s.PGSQL.5599"
2025-07-10 12:40:57.320 MST [466533] LOG:  database system was interrupted; last kCLOCK_TIMESTAMPn up at 2025-07-10 12:36:00 MST
2025-07-10 12:40:57.365 MST [466533] LOG:  starting point-in-time recovery to 2025-07-10 12:36:52.242927-07
2025-07-10 12:40:57.365 MST [466533] LOG:  starting backup recovery with redo LSN 0/3000028, checkpoint LSN 0/3000060, on timeline ID 1
2025-07-10 12:40:57.386 MST [466533] LOG:  restored log file "000000010000000000000003" from archive
2025-07-10 12:40:57.406 MST [466533] LOG:  redo starts at 0/3000028
2025-07-10 12:40:57.427 MST [466533] LOG:  restored log file "000000010000000000000004" from archive
2025-07-10 12:40:57.440 MST [466533] LOG:  completed backup recovery with redo LSN 0/3000028 and end LSN 0/3000138
2025-07-10 12:40:57.440 MST [466533] LOG:  consistent recovery state reached at 0/3000138
2025-07-10 12:40:57.440 MST [466529] LOG:  database system is ready to accept read-only connections
2025-07-10 12:40:57.444 MST [466533] LOG:  recovery stopping before commit of transaction 732, time 2025-07-10 12:36:58.237185-07
2025-07-10 12:40:57.444 MST [466533] LOG:  redo done at 0/4046FB0 system usage: CPU: user: 0.00 s, system: 0.00 s, elapsed: 0.03 s
2025-07-10 12:40:57.444 MST [466533] LOG:  last completed transaction was at log time 2025-07-10 12:36:47.857213-07
cp: cannot stat '/sysx/data16/DATANEW/backup_wal/00000002.history': No such file or directory
2025-07-10 12:40:57.450 MST [466533] LOG:  selected new timeline ID: 2
cp: cannot stat '/sysx/data16/DATANEW/backup_wal/00000001.history': No such file or directory
2025-07-10 12:40:57.493 MST [466533] LOG:  archive recovery complete
2025-07-10 12:40:57.494 MST [466531] LOG:  checkpoint starting: end-of-recovery immediate wait
2025-07-10 12:40:57.506 MST [466531] LOG:  checkpoint complete: wrote 67 buffers (0.4%); 0 WAL file(s) added, 0 removed, 0 recycled; write=0.007 s, sync=0.003 s, total=0.013 s; sync files=47, longest=0.001 s, average=0.001 s; distance=16667 kB, estimate=16667 kB; lsn=0/4046FB0, redo lsn=0/4046FB0
2025-07-10 12:40:57.511 MST [466529] LOG:  database system is ready to accept connections
postgres@lvt-pruebas-dba-cln /sysx/data16/DATANEW/PITR $

```
